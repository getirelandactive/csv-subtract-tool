<!-- Only the updated parts are shown below for brevity -->

<h1>CSV Subtract Tool <span style="font-size:0.8em; color:#666;">(v2.2)</span></h1>

<!-- Add this new container below summary-container -->
<div id="debug-container" style="margin-top:2em;"></div>

<script>
  // Add this new function
  function generateDebugTable(fullKeys, subsetKeys, matchedKeys, remainingKeys) {
    const table = document.createElement('table');
    table.className = 'summary-table';

    const headerRow = document.createElement('tr');
    ['Key', 'In Full CSV', 'In Subset CSV', 'Matched', 'Remaining'].forEach(label => {
      const th = document.createElement('th');
      th.textContent = label;
      headerRow.appendChild(th);
    });
    table.appendChild(headerRow);

    const allKeys = Array.from(new Set([...fullKeys, ...subsetKeys])).sort();

    allKeys.forEach(key => {
      const tr = document.createElement('tr');
      const inFull = fullKeys.includes(key);
      const inSubset = subsetKeys.includes(key);
      const isMatched = matchedKeys.includes(key);
      const isRemaining = remainingKeys.includes(key);

      [key, inFull, inSubset, isMatched, isRemaining].forEach(val => {
        const td = document.createElement('td');
        td.textContent = typeof val === 'boolean' ? (val ? '‚úîÔ∏è' : '') : val;
        tr.appendChild(td);
      });

      table.appendChild(tr);
    });

    const container = document.getElementById('debug-container');
    container.innerHTML = '<h3>üîç Debug Key Comparison</h3>';
    container.appendChild(table);
  }

  // Modify processCSV to call generateDebugTable
  function processCSV() {
    const fullFile = document.getElementById('fullFile').files[0];
    const subsetFile = document.getElementById('subsetFile').files[0];

    if (!fullFile || !subsetFile) {
      alert('Please select both files.');
      return;
    }

    Promise.all([fullFile.text(), subsetFile.text()]).then(([fullText, subsetText]) => {
      const full = parseCSV(fullText);
      const subset = parseCSV(subsetText);

      const possibleKeys = [
        'objectid',
        'objectid_1',
        'id',
        'uid',
        'featureid',
        'recordid',
        'roll number',
        'rollnumber'
      ];

      const keyField = full.headers.find(h =>
        possibleKeys.includes(h.trim().toLowerCase())
      );

      if (!keyField) {
        alert('Could not find a valid key field in the full dataset.');
        console.warn('Available headers:', full.headers);
        return;
      }

      console.log(`Matched key field: "${keyField}"`);

      const fullKeys = full.rows.map(r => (r[keyField] || '').trim());
      const subsetKeys = subset.rows.map(r => (r[keyField] || '').trim());

      const fullSet = new Set(fullKeys);
      const matchedKeys = subsetKeys.filter(k => fullSet.has(k));
      const remaining = full.rows.filter(r => {
        const val = (r[keyField] || '').trim();
        return val && !subsetKeys.includes(val);
      });

      const remainingKeys = remaining.map(r => (r[keyField] || '').trim());

      lastHeaders = full.headers;
      lastRemaining = remaining;

      generateSummaryTable(full.rows, subset.rows, keyField, remaining);
      generateDebugTable(fullKeys, subsetKeys, matchedKeys, remainingKeys);
      displayTable(full.headers, remaining);
      document.getElementById('downloadBtn').style.display = 'inline-block';
    });
  }
</script>
