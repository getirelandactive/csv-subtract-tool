<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CSV Subtract Tool</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1rem;
      max-width: 600px;
      margin: auto;
    }
    label {
      display: block;
      margin-top: 1rem;
      font-weight: bold;
    }
    input[type="file"] {
      margin-top: 0.5rem;
    }
    button {
      margin-top: 1.5rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
    }
    table {
      margin-top: 2rem;
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
    #downloadBtn {
      margin-top: 1rem;
      display: none;
    }
  </style>
</head>
<body>
  <h2>Subtract Subset from Full CSV</h2>

  <label>Full Dataset CSV:</label>
  <input type="file" id="fullCsv" accept=".csv" />

  <label>Subset CSV:</label>
  <input type="file" id="subsetCsv" accept=".csv" />

  <button id="processBtn">Process</button>
  <button id="downloadBtn">Download Result</button>

  <div id="output"></div>

  <script>
    document.getElementById('processBtn').addEventListener('click', async () => {
      const fullFile = document.getElementById('fullCsv').files[0];
      const subsetFile = document.getElementById('subsetCsv').files[0];

      if (!fullFile || !subsetFile) {
        alert('Please upload both CSVs.');
        return;
      }

      const [fullData, subsetData] = await Promise.all([
        parseCsv(fullFile),
        parseCsv(subsetFile)
      ]);

      const keyField = detectKeyField(fullData[0]);
      if (!keyField) {
        alert('No valid key field found. Expected one of: OBJECTID_1, Roll Number, TrailID');
        return;
      }

      const subsetKeys = new Set(subsetData.map(row => row[keyField]));
      const remaining = fullData.filter(row => !subsetKeys.has(row[keyField]));

      renderTable(remaining);
      enableDownload(remaining);
    });

    function detectKeyField(row) {
      const candidates = ['objectid_1', 'roll number', 'trailid'];
      const headers = Object.keys(row).map(h => h.toLowerCase());

      for (let i = 0; i < headers.length; i++) {
        if (candidates.includes(headers[i])) {
          return Object.keys(row)[i]; // Preserve original casing
        }
      }
      return null;
    }

    function parseCsv(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const lines = reader.result.split(/\r?\n/).filter(line => line.trim() !== '');
          const headers = lines[0].split(',');
          const data = lines.slice(1).map(line => {
            const values = line.split(',');
            const row = {};
            headers.forEach((h, i) => row[h.trim()] = values[i]?.trim() || '');
            return row;
          });
          resolve(data);
        };
        reader.onerror = reject;
        reader.readAsText(file);
      });
    }

    function renderTable(data) {
      const output = document.getElementById('output');
      output.innerHTML = '';

      if (data.length === 0) {
        output.textContent = 'No remaining records.';
        return;
      }

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');

      Object.keys(data[0]).forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      data.forEach(row => {
        const tr = document.createElement('tr');
        Object.values(row).forEach(value => {
          const td = document.createElement('td');
          td.textContent = value;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      output.appendChild(table);
    }

    function enableDownload(data) {
      const btn = document.getElementById('downloadBtn');
      btn.style.display = 'inline-block';

      btn.onclick = () => {
        const headers = Object.keys(data[0]);
        const rows = data.map(row => headers.map(h => `"${row[h]}"`).join(','));
        const csvContent = [headers.join(','), ...rows].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = 'remaining_records.csv';
        a.click();
        URL.revokeObjectURL(url);
      };
    }
  </script>
</body>
</html>
