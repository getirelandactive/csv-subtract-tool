<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CSV Key Diagnostic</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    .summary-table { border-collapse: collapse; width: 100%; margin-top: 1em; }
    .summary-table th, .summary-table td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    .summary-table th { background-color: #f2f2f2; }
    h3 { margin-top: 2em; }
  </style>
</head>
<body>
  <h2>CSV Key Diagnostic Tool</h2>
  <input type="file" id="csvFileInput" accept=".csv" />
  <div id="summary-container"></div>
  <div id="debug-container"></div>
  <div id="diagnostic-container" style="margin-top:2em;"></div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    function processCSV(csvText) {
      const data = Papa.parse(csvText, { header: true }).data;

      const fullKeys = data.map(row => row['full_key']).filter(Boolean);
      const subsetKeys = data.map(row => row['subset_key']).filter(Boolean);

      const fullSet = new Set(fullKeys);
      const subsetSet = new Set(subsetKeys);

      const matchedKeys = subsetKeys.filter(k => fullSet.has(k));
      const unmatchedKeys = subsetKeys.filter(k => !fullSet.has(k));

      const duplicates = fullKeys.filter((k, i, arr) => arr.indexOf(k) !== i);
      const duplicateSet = [...new Set(duplicates)];

      generateSummaryTable(fullKeys.length, subsetKeys.length, matchedKeys.length, unmatchedKeys.length);
      generateDebugTable(matchedKeys, unmatchedKeys);
      generateDiagnosticTable(duplicateSet, unmatchedKeys);
    }

    function generateSummaryTable(fullCount, subsetCount, matchCount, unmatchedCount) {
      const container = document.getElementById('summary-container');
      container.innerHTML = '<h3>üìä Summary</h3>';
      container.innerHTML += `
        <table class="summary-table">
          <tr><th>Metric</th><th>Count</th></tr>
          <tr><td>Total Full Keys</td><td>${fullCount}</td></tr>
          <tr><td>Total Subset Keys</td><td>${subsetCount}</td></tr>
          <tr><td>Matched Keys</td><td>${matchCount}</td></tr>
          <tr><td>Unmatched Keys</td><td>${unmatchedCount}</td></tr>
        </table>
      `;
    }

    function generateDebugTable(matchedKeys, unmatchedKeys) {
      const container = document.getElementById('debug-container');
      container.innerHTML = '<h3>üîç Debug Details</h3>';

      const table = document.createElement('table');
      table.className = 'summary-table';

      const headerRow = document.createElement('tr');
      ['Key Type', 'Key Value'].forEach(label => {
        const th = document.createElement('th');
        th.textContent = label;
        headerRow.appendChild(th);
      });
      table.appendChild(headerRow);

      matchedKeys.forEach(key => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>Matched</td><td>${key}</td>`;
        table.appendChild(tr);
      });

      unmatchedKeys.forEach(key => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>Unmatched</td><td>${key}</td>`;
        table.appendChild(tr);
      });

      container.appendChild(table);
    }

    function generateDiagnosticTable(duplicateKeys = [], unmatchedKeys = []) {
      const container = document.getElementById('diagnostic-container');
      container.innerHTML = '<h3>üß™ Diagnostic Report</h3>';

      const table = document.createElement('table');
      table.className = 'summary-table';

      const headerRow = document.createElement('tr');
      ['Issue Type', 'Key Value'].forEach(label => {
        const th = document.createElement('th');
        th.textContent = label;
        headerRow.appendChild(th);
      });
      table.appendChild(headerRow);

      duplicateKeys.forEach(key => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>Duplicate in Full</td><td>${key}</td>`;
        table.appendChild(tr);
      });

      unmatchedKeys.forEach(key => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>Unmatched in Subset</td><td>${key}</td>`;
        table.appendChild(tr);
      });

      container.appendChild(table);
    }

    document.getElementById('csvFileInput').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (event) {
        processCSV(event.target.result);
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>
