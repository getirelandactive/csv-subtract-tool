// csv-subtract-tool.js

const fs = require('fs');
const path = require('path');
const DEBUG = true; // Set to false to suppress debug logs

function readCSV(filePath) {
  const raw = fs.readFileSync(filePath, 'utf-8');
  const lines = raw.trim().split('\n');
  const headers = lines[0].split(',').map(h => h.trim());
  const rows = lines.slice(1).map(line => {
    const values = line.split(',').map(v => v.trim());
    return Object.fromEntries(headers.map((h, i) => [h, values[i]]));
  });
  return { headers, rows };
}

function writeCSV(filePath, headers, rows) {
  const content = [headers.join(',')].concat(
    rows.map(row => headers.map(h => row[h] ?? '').join(','))
  ).join('\n');
  fs.writeFileSync(filePath, content, 'utf-8');
}

function summarize(fullRows, subsetRows, keyField) {
  const fullKeys = fullRows.map(r => r[keyField]?.trim().toLowerCase());
  const subsetKeys = subsetRows.map(r => r[keyField]?.trim().toLowerCase());

  const fullSet = new Set(fullKeys);
  const subsetSet = new Set(subsetKeys);

  const duplicates = fullKeys.length - fullSet.size;
  const matchedKeys = subsetKeys.filter(k => fullSet.has(k));
  const unmatchedKeys = subsetKeys.filter(k => !fullSet.has(k));

  console.log('\nğŸ“Š Summary Table');
  console.table({
    'Full dataset size': fullRows.length,
    'Subset size': subsetRows.length,
    'Unique keys in full': fullSet.size,
    'Duplicate keys in full': duplicates,
    'Matching keys': matchedKeys.length,
    'Unmatched keys': unmatchedKeys.length,
    'Expected remaining': fullRows.length - matchedKeys.length,
  });

  if (DEBUG && unmatchedKeys.length > 0) {
    console.log('âš ï¸ Subset keys not found in full dataset:', unmatchedKeys);
  }

  return new Set(subsetKeys);
}

function subtractCSV(fullPath, subsetPath, outputPath, keyField) {
  const full = readCSV(fullPath);
  const subset = readCSV(subsetPath);

  const subsetKeys = summarize(full.rows, subset.rows, keyField);

  const remaining = full.rows.filter(row => {
    const val = row[keyField]?.trim().toLowerCase();
    const keep = !subsetKeys.has(val);
    if (DEBUG && !keep) {
      console.log('Subtracting:', val);
    }
    return keep;
  });

  console.log(`\nâœ… Remaining records: ${remaining.length}`);
  writeCSV(outputPath, full.headers, remaining);
  console.log(`ğŸ“ Output written to: ${outputPath}`);
}

// ğŸ§ª Example usage
const fullCSV = path.resolve(__dirname, 'full.csv');
const subsetCSV = path.resolve(__dirname, 'subset.csv');
const outputCSV = path.resolve(__dirname, 'remaining.csv');
const keyField = 'ObjectId';

subtractCSV(fullCSV, subsetCSV, outputCSV, keyField);
